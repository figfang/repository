<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐廳訂位管理系統</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
    <!-- 登入頁面 -->
    <div class="container mt-5" id="loginPage">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">管理員登入</h4>
                    </div>
                    <div class="card-body">
                        <form id="adminLoginForm">
                            <div class="mb-3">
                                <label for="adminEmail" class="form-label">帳號</label>
                                <input type="email" class="form-control" id="adminEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="adminPassword" class="form-label">密碼</label>
                                <input type="password" class="form-control" id="adminPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">登入</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要內容區 -->
    <div id="mainContent" style="display: none;">
    <!-- 原本的導航欄和內容 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">餐廳訂位管理系統</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showAllBookings()">訂位管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTimeSlots()">時段管理</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 訂位管理區 -->
        <div id="bookingManagement">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">訂位管理</h4>
                        <div>
                            <button class="btn btn-success me-2" onclick="refreshBookings()">
                                <i class="fas fa-sync-alt"></i> 刷新
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                                    篩選狀態
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="filterBookings('all')">全部</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterBookings(0)">待確認</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterBookings(1)">已確認</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterBookings(2)">已取消</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>訂位編號</th>
                                    <th>會員資訊</th>
                                    <th>訂位日期</th>
                                    <th>時段</th>
                                    <th>人數</th>
                                    <th>狀態</th>
                                    <th>建立時間</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody">
                                <!-- 訂位資料將動態插入這裡 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 訂位詳情 Modal -->
        <div class="modal fade" id="bookingDetailModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">訂位詳情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <h6>訂位資訊</h6>
                            <p>訂位編號：<span id="detailBookingId"></span></p>
                            <p>訂位日期：<span id="detailDate"></span></p>
                            <p>用餐時段：<span id="detailTime"></span></p>
                            <p>用餐人數：<span id="detailPeople"></span></p>
                            <p>訂位狀態：<span id="detailStatus"></span></p>
                        </div>
                        <div class="mb-3">
                            <h6>會員資訊</h6>
                            <p>姓名：<span id="detailName"></span></p>
                            <p>電話：<span id="detailPhone"></span></p>
                            <p>Email：<span id="detailEmail"></span></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="confirmBooking()">確認訂位</button>
                        <button type="button" class="btn btn-danger" onclick="cancelBooking()">取消訂位</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // 檢查登入狀態
    function checkLoginStatus() {
        const adminToken = localStorage.getItem('adminToken');
        if (!adminToken) {
            $('#loginPage').show();
            $('#mainContent').hide();
        } else {
            $('#loginPage').hide();
            $('#mainContent').show();
            loadAllBookings();
        }
    }

    // 頁面載入時檢查登入狀態
    $(document).ready(function() {
        checkLoginStatus();

        // 處理管理員登入
        $('#adminLoginForm').on('submit', function(e) {
            e.preventDefault();
            
            const loginData = {
                email: $('#adminEmail').val(),
                password: $('#adminPassword').val()
            };

            $.ajax({
                url: '/api/admin/login',
                method: 'POST',
                data: JSON.stringify(loginData),
                contentType: 'application/json',
                success: function(response) {
                    if (response.token) {
                        localStorage.setItem('adminToken', response.token);
                        $('#loginPage').hide();
                        $('#mainContent').show();
                        loadAllBookings();
                    }
                },
                error: function(xhr) {
                    alert('登入失敗：' + (xhr.responseJSON?.message || '請檢查帳號密碼'));
                }
            });
        });
    });
    </script>

    <script>
    let currentBookingId = null;

    // 頁面載入時顯示所有訂位
    $(document).ready(function() {
        loadAllBookings();
    });

    // 載入所有訂位
    function loadAllBookings() {
        const adminToken = localStorage.getItem('adminToken');
        if (!adminToken) {
            checkLoginStatus();
            return;
        }

        $.ajax({
            url: '/api/admin/bookings',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + adminToken
            },
            success: function(bookings) {
                updateBookingTable(bookings);
            },
            error: function(xhr) {
                if (xhr.status === 401) {
                    localStorage.removeItem('adminToken');
                    checkLoginStatus();
                } else {
                    alert('載入訂位資料失敗');
                }
            }
        });
    }

    // 更新訂位表格
    function updateBookingTable(bookings) {
        const tbody = $('#bookingTableBody');
        tbody.empty();

        bookings.forEach(booking => {
            const statusText = getStatusText(booking.status);
            const statusClass = getStatusClass(booking.status);

            const row = $('<tr>');
            row.html(`
                <td>${booking.bookingId}</td>
                <td>
                    ${booking.member.name}<br>
                    <small class="text-muted">${booking.member.phoneNumber}</small>
                </td>
                <td>${booking.bookingDate}</td>
                <td>${formatTimeSlot(booking.timeSlot)}</td>
                <td>${booking.numberOfPeople}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>${formatDateTime(booking.createTime)}</td>
                <td>
                    <button class="btn btn-sm btn-info me-1" onclick="showBookingDetail(${booking.bookingId})">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    ${booking.status === 0 ? `
                        <button class="btn btn-sm btn-success me-1" onclick="confirmBooking(${booking.bookingId})">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    ${booking.status !== 2 ? `
                        <button class="btn btn-sm btn-danger" onclick="cancelBooking(${booking.bookingId})">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                </td>
            `);
            tbody.append(row);
        });
    }

    // 顯示訂位詳情
    function showBookingDetail(bookingId) {
        currentBookingId = bookingId;
        $.ajax({
            url: `/api/admin/bookings/${bookingId}`,
            method: 'GET',
            success: function(booking) {
                $('#detailBookingId').text(booking.bookingId);
                $('#detailDate').text(booking.bookingDate);
                $('#detailTime').text(formatTimeSlot(booking.timeSlot));
                $('#detailPeople').text(booking.numberOfPeople);
                $('#detailStatus').text(getStatusText(booking.status));
                $('#detailName').text(booking.member.name);
                $('#detailPhone').text(booking.member.phoneNumber);
                $('#detailEmail').text(booking.member.email);
                
                new bootstrap.Modal('#bookingDetailModal').show();
            },
            error: function(xhr) {
                alert('載入訂位詳情失敗');
            }
        });
    }

    // 確認訂位
    function confirmBooking(bookingId) {
        if (confirm('確定要確認這筆訂位嗎？')) {
            $.ajax({
                url: `/api/admin/bookings/${bookingId}/status?status=1`,
                method: 'PUT',
                success: function(response) {
                    alert('訂位已確認');
                    loadAllBookings();
                    if(bootstrap.Modal.getInstance('#bookingDetailModal')) {
                        bootstrap.Modal.getInstance('#bookingDetailModal').hide();
                    }
                },
                error: function(xhr) {
                    alert('確認訂位失敗');
                }
            });
        }
    }

    // 取消訂位
    function cancelBooking(bookingId) {
        if (confirm('確定要取消這筆訂位嗎？')) {
            $.ajax({
                url: `/api/admin/bookings/${bookingId}`,
                method: 'DELETE',
                success: function(response) {
                    alert('訂位已取消');
                    loadAllBookings();
                    if(bootstrap.Modal.getInstance('#bookingDetailModal')) {
                        bootstrap.Modal.getInstance('#bookingDetailModal').hide();
                    }
                },
                error: function(xhr) {
                    alert('取消訂位失敗');
                }
            });
        }
    }

    // 刷新訂位列表
    function refreshBookings() {
        loadAllBookings();
    }

    // 篩選訂位
    function filterBookings(status) {
        let url = '/api/admin/bookings';
        if (status !== 'all') {
            url += `?status=${status}`;
        }
        $.ajax({
            url: url,
            method: 'GET',
            success: function(bookings) {
                updateBookingTable(bookings);
            },
            error: function(xhr) {
                alert('篩選訂位失敗');
            }
        });
    }

    // 格式化時段顯示
    function formatTimeSlot(timeSlot) {
        return `${timeSlot.startTime.substring(11, 16)}-${timeSlot.endTime.substring(11, 16)}`;
    }

    // 格式化日期時間
    function formatDateTime(datetime) {
        return new Date(datetime).toLocaleString('zh-TW');
    }

    // 獲取狀態文字
    function getStatusText(status) {
        const statusMap = {
            0: '待確認',
            1: '已確認',
            2: '已取消'
        };
        return statusMap[status] || '未知狀態';
    }

    // 獲取狀態樣式
    function getStatusClass(status) {
        const classMap = {
            0: 'bg-warning',
            1: 'bg-success',
            2: 'bg-danger'
        };
        return classMap[status] || 'bg-secondary';
    }
    </script>
</body>
</html>